<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Budget Template</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Title of the budget sheet -->
    <header>
      <h1 id="budgetTitle">Loading...</h1>
      <h1><span id="totalBalance1">+ $0.00</span></h1>
    </header>

    <!-- Buttons to Add Winnings, Spending -->
    <div class="add-buttons">
      <button id="addWinningsBtn" class="btn-primary">+ Winnings</button>
      <button id="addSpendingBtn" class="btn-secondary">- Spendings</button>
    </div>

    <!-- Transactions List -->
    <section id="transactions">
      <!-- Transactions will be populated here -->
    </section>

    <!-- Toggle Visibility of Limits and Progress Bars -->
    <button id="toggleLimitsBtn" class="btn-limit">Show Spending Limits</button>

    <!-- Progress Bars for Weekly, Monthly, and Yearly Limits (Initially hidden) -->
    <div id="limitSection" class="progress-bars hidden">
      <div>
        <p>Weekly Limit: <span id="weeklyLimitProgress">0%</span></p>
        <div class="progress-bar-container">
          <div id="weeklyProgressBar" class="progress-bar"></div>
        </div>
      </div>
      <div>
        <p>Monthly Limit: <span id="monthlyLimitProgress">0%</span></p>
        <div class="progress-bar-container">
          <div id="monthlyProgressBar" class="progress-bar"></div>
        </div>
      </div>
      <div>
        <p>Yearly Limit: <span id="yearlyLimitProgress">0%</span></p>
        <div class="progress-bar-container">
          <div id="yearlyProgressBar" class="progress-bar"></div>
        </div>
      </div>

      <!-- Button to Set Spending Limits -->
      <button id="setLimitBtn" class="btn-limit">Set Spending Limit</button>
    </div>

    <!-- Summary Section for Income, Expenses, and Balance -->
    <div class="summary-section">
      <p>Winnings: <span id="totalIncome">+ $0.00</span></p>
      <p>Spendings: <span id="totalExpenses">- $0.00</span></p>
      <p>Balance: <span id="totalBalance">+ $0.00</span></p>
    </div>

    <!-- Modal for Adding Transactions -->
    <div id="transactionModal" class="modal">
      <div class="modal-content">
        <h2 id="modalTitle">Add Transaction</h2>
        <label for="transactionAmount">Amount:</label>
        <input type="number" id="transactionAmount" required>
        <label for="transactionDate">Date:</label>
        <input type="date" id="transactionDate" required>
        <label for="transactionDetails">Details:</label>
        <input type="text" id="transactionDetails" required>
        <button id="saveTransactionBtn" class="btn-primary">Save</button>
        <button id="closeModal" class="btn-secondary">Close</button>
      </div>
    </div>

    <!-- Modal for Setting Spending Limit -->
    <div id="limitModal" class="modal">
      <div class="modal-content">
        <h2>Set Spending Limits</h2>
        <label for="weeklyLimit">Weekly Limit:</label>
        <input type="number" id="weeklyLimit" required>
        <label for="monthlyLimit">Monthly Limit:</label>
        <input type="number" id="monthlyLimit" required>
        <label for="yearlyLimit">Yearly Limit:</label>
        <input type="number" id="yearlyLimit" required>
        <button id="saveLimitBtn" class="btn-primary">Save Limits</button>
        <button id="closeLimitModal" class="btn-secondary">Close</button>
      </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
      <button class="nav-item" id="navBudgets">
        <i class="icon-home"></i>
        <span>Budgets</span>
      </button>
      <button class="nav-item" id="navStarred">
        <i class="icon-star"></i>
        <span>Starred</span>
      </button>
      <button class="nav-item" id="navSettings">
        <i class="icon-settings"></i>
        <span>Settings</span>
      </button>
      <button class="nav-item" id="navAccount">
        <i class="icon-account"></i>
        <span>Account</span>
      </button>
    </nav>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const budgetIndex = urlParams.get('budgetIndex');

    let balanceSheets = JSON.parse(localStorage.getItem('balanceSheets')) || [];
    let transactions = JSON.parse(localStorage.getItem('transactions')) || {};
    let spendingLimits = JSON.parse(localStorage.getItem('spendingLimits')) || { weekly: 0, monthly: 0, yearly: 0 };

    if (budgetIndex !== null && balanceSheets[budgetIndex]) {
      const budget = balanceSheets[budgetIndex];
      document.getElementById('budgetTitle').textContent = budget.title;
      renderTransactions(budget.title);
      calculateSummary();
      updateProgressBars();
    } else {
      document.getElementById('budgetTitle').textContent = 'Budget Not Found';
    }

    function renderTransactions(budgetTitle) {
      const transactionsList = transactions[budgetTitle] || [];
      const transactionsContainer = document.getElementById('transactions');
      transactionsContainer.innerHTML = '';

      transactionsList.forEach((transaction, index) => {
        const transactionItem = document.createElement('div');
        transactionItem.classList.add('transaction-item');
        transactionItem.innerHTML = `
          <div class="transaction-details">
            <p>${transaction.details}</p>
            <p>${transaction.date}</p>
          </div>
          <p class="transaction-amount ${transaction.type}">${transaction.type === 'income' ? '+' : '-'} $${transaction.amount.toFixed(2)}</p>

          <!-- More Options Menu for each transaction -->
          <div class="transaction-options">
            <button class="more-btn">â‹®</button>
            <div class="transaction-dropdown-content">
              <button class="edit-transaction-btn" data-index="${index}">Edit</button>
              <button class="delete-transaction-btn" data-index="${index}">Delete</button>
              <button class="duplicate-transaction-btn" data-index="${index}">Duplicate</button>
            </div>
          </div>
        `;
        transactionsContainer.appendChild(transactionItem);

        // More Options Dropdown interaction
        const moreBtn = transactionItem.querySelector('.more-btn');
        const transactionOptions = transactionItem.querySelector('.transaction-options');

        moreBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          transactionOptions.classList.toggle('active');
        });

        // Edit Transaction
        const editBtn = transactionItem.querySelector('.edit-transaction-btn');
        editBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          openEditTransactionModal(index, budgetTitle);
        });

        // Delete Transaction
        const deleteBtn = transactionItem.querySelector('.delete-transaction-btn');
        deleteBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          deleteTransaction(index, budgetTitle);
        });

        // Duplicate Transaction
        const duplicateBtn = transactionItem.querySelector('.duplicate-transaction-btn');
        duplicateBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          duplicateTransaction(index, budgetTitle);
        });
      });
    }

    // Open modal to edit a transaction
    function openEditTransactionModal(index, budgetTitle) {
      const transaction = transactions[budgetTitle][index];
      if (!transaction) {
        console.error('Transaction not found');
        return;
      }

      document.getElementById('transactionAmount').value = transaction.amount;
      document.getElementById('transactionDate').value = transaction.date;
      document.getElementById('transactionDetails').value = transaction.details;

      document.getElementById('saveTransactionBtn').onclick = function () {
        const newAmount = parseFloat(document.getElementById('transactionAmount').value);
        const newDate = document.getElementById('transactionDate').value;
        const newDetails = document.getElementById('transactionDetails').value;

        if (newAmount && newDate && newDetails) {
          transactions[budgetTitle][index] = { 
            amount: newAmount, 
            date: newDate, 
            details: newDetails, 
            type: transaction.type
          };
          localStorage.setItem('transactions', JSON.stringify(transactions));
          renderTransactions(budgetTitle);
          document.getElementById('transactionModal').classList.remove('active');
        } else {
          alert('Please fill out all fields.');
        }
      };

      document.getElementById('transactionModal').classList.add('active');
    }

    // Delete a transaction
    function deleteTransaction(index, budgetTitle) {
      transactions[budgetTitle].splice(index, 1);
      localStorage.setItem('transactions', JSON.stringify(transactions));
      renderTransactions(budgetTitle);
    }

    // Duplicate a transaction
    function duplicateTransaction(index, budgetTitle) {
      const transaction = transactions[budgetTitle][index];
      if (transaction) {
        const newTransaction = { ...transaction };
        transactions[budgetTitle].push(newTransaction);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        renderTransactions(budgetTitle);
      } else {
        console.error('Transaction not found for duplication');
      }
    }

    // Close transaction modal
    document.getElementById('closeModal').addEventListener('click', function () {
      document.getElementById('transactionModal').classList.remove('active');
    });

    // Initialize navigation buttons
    document.getElementById('navBudgets').addEventListener('click', function () {
      navigateTo('main.html');
    });
    document.getElementById('navStarred').addEventListener('click', function () {
      navigateTo('starred.html');
    });
    document.getElementById('navSettings').addEventListener('click', function () {
      navigateTo('settings.html');
    });
    document.getElementById('navAccount').addEventListener('click', function () {
      navigateTo('account.html');
    });

    function navigateTo(page) {
      window.location.href = page;
    }
  </script>
</body>
</html>
